# .github/workflows/update_rss.yml
name: è‡ªå‹•æ›´æ–° Yahoo/PChome RSS

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å°ç£ä¸Šåˆ 10:00ï¼ˆUTC+8ï¼‰
  workflow_dispatch:     # ä¹Ÿå…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ä¸‹è¼‰ Repo åŸå§‹ç¢¼
        uses: actions/checkout@v3

      - name: è¨­å®š Python ç’°å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: å®‰è£å¿…è¦å¥—ä»¶
        run: |
          pip install requests beautifulsoup4

      - name: å»ºç«‹ rss ç›®éŒ„
        run: mkdir -p rss

      - name: å¯«å…¥ RSS ç”¢ç”Ÿå™¨ç¨‹å¼ç¢¼ï¼ˆä¿®æ­£ç›®éŒ„ï¼‰
        run: |
          cat << 'EOF' > rss/yahoo_pchome_rss_fixed.py
          import requests
          from bs4 import BeautifulSoup
          import xml.etree.ElementTree as ET
          from datetime import datetime

          sources = {
              "Yahoo ç¾é£Ÿ": "https://tw.news.yahoo.com/food",
              "Yahoo æ™¯é»": "https://tw.news.yahoo.com/tourist-spots",
              "PChome æ—…éŠ": "https://news.pchome.com.tw/cat/travel",
              "PChome ç†±é–€æ—…éŠ": "https://news.pchome.com.tw/cat/travel/hot"
          }

          def fetch_articles(name, url):
              try:
                  res = requests.get(url, timeout=10)
                  soup = BeautifulSoup(res.text, "html.parser")
                  articles = []

                  if "yahoo.com" in url:
                      for a in soup.select("a[href*='/news/']"):
                          title = a.text.strip()
                          link = a.get("href")
                          if title and link and not any(k in title for k in ["è‚¡", "ç¨…", "è²¡ç¶“"]):
                              if not link.startswith("http"):
                                  link = "https://tw.news.yahoo.com" + link
                              articles.append((name, title, link))
                  elif "pchome.com.tw" in url:
                      for a in soup.select(".news_list a"):
                          title = a.text.strip()
                          link = a.get("href")
                          if title and link:
                              articles.append((name, title, link))
                  return articles[:10]  # æ¯å€‹ä¾†æºæœ€å¤š 10 ç­†
              except Exception as e:
                  print(f"[éŒ¯èª¤] {name}: {e}")
                  return []

          def build_rss(all_articles, output_file="rss/yahoo_pchome_travel.xml"):
              rss = ET.Element("rss", version="2.0")
              channel = ET.SubElement(rss, "channel")
              ET.SubElement(channel, "title").text = "è‡ªè£½ Yahoo + PChome æ—…éŠ RSS"
              ET.SubElement(channel, "link").text = "https://bill4528kimo.github.io/rss/yahoo_pchome_travel.xml"
              ET.SubElement(channel, "description").text = "Yahoo ç¾é£Ÿèˆ‡æ™¯é»ã€PChome æ—…éŠæ–°è RSS"
              ET.SubElement(channel, "lastBuildDate").text = datetime.now().strftime("%a, %d %b %Y %H:%M:%S +0800")

              for source, title, link in all_articles:
                  item = ET.SubElement(channel, "item")
                  ET.SubElement(item, "title").text = title
                  ET.SubElement(item, "link").text = link
                  ET.SubElement(item, "description").text = f"{source} æä¾›"
                  ET.SubElement(item, "guid").text = link
                  ET.SubElement(item, "pubDate").text = datetime.now().strftime("%a, %d %b %Y %H:%M:%S +0800")

              tree = ET.ElementTree(rss)
              tree.write(output_file, encoding="utf-8", xml_declaration=True)
              print(f"âœ… å·²ç”¢å‡º RSS æª”ï¼š{output_file}")

          def main():
              all_articles = []
              for name, url in sources.items():
                  print(f"æŠ“å–ä¸­ï¼š{name}")
                  all_articles += fetch_articles(name, url)
              build_rss(all_articles)

          if __name__ == "__main__":
              main()
          EOF

      - name: åŸ·è¡Œ RSS ç”¢ç”Ÿå™¨ï¼ˆä¿®æ­£è·¯å¾‘ï¼‰
        run: |
          python rss/yahoo_pchome_rss_fixed.py

      - name: æäº¤æ›´æ–°çš„ XML æª”æ¡ˆ
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add rss/yahoo_pchome_travel.xml
          git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–° RSS è³‡æ–™ ($(date +'%Y-%m-%d %H:%M'))" || echo "No changes to commit"
          git push
